<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Carto - Commands</title>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <script>
        // Fonction globale pour ouvrir l'application
        // Doit être définie AVANT Office.onReady
        function openApp(event) {
            console.log('[Commands] openApp called');

            try {
                // Calculer l'URL de l'application
                const baseUrl = window.location.origin + window.location.pathname.replace('/html/commands.html', '');
                const appUrl = baseUrl + '/html/app.html';

                console.log('[Commands] Opening app:', appUrl);

                // Ouvrir l'application en mode dialog plein écran
                Office.context.ui.displayDialogAsync(
                    appUrl,
                    {
                        height: 100,
                        width: 100,
                        displayInIframe: false,
                        promptBeforeOpen: false
                    },
                    function(asyncResult) {
                        if (asyncResult.status === Office.AsyncResultStatus.Failed) {
                            console.error('[Commands] Dialog failed:', asyncResult.error.message);
                            event.completed();
                        } else {
                            console.log('[Commands] Dialog opened successfully');
                            var dialog = asyncResult.value;

                            // Gérer la fermeture de la dialog
                            dialog.addEventHandler(Office.EventType.DialogEventReceived, function(args) {
                                console.log('[Commands] Dialog event:', args);
                                if (args.error === 12006) {
                                    // Dialog fermée par l'utilisateur
                                    console.log('[Commands] Dialog closed by user');
                                }
                            });

                            // Signaler la fin de la commande
                            event.completed();
                        }
                    }
                );
            } catch (error) {
                console.error('[Commands] Error:', error);
                event.completed();
            }
        }

        // Initialisation Office
        Office.onReady(function(info) {
            console.log('[Commands] Office.onReady, host:', info.host);

            // Enregistrer la fonction de commande
            if (Office.actions && Office.actions.associate) {
                Office.actions.associate('openApp', openApp);
                console.log('[Commands] Function openApp registered with Office.actions.associate');
            } else {
                console.log('[Commands] Office.actions.associate not available, function is global');
            }
        });

        // Fallback: exposer la fonction globalement pour les anciennes versions
        window.openApp = openApp;
    </script>
</head>
<body>
    <!-- Ce fichier est utilisé uniquement pour les commandes du ruban -->
    <p>Carto Commands - Ce fichier charge les commandes du ruban.</p>
</body>
</html>
